<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KUAPC-DAS</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#001f3f">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <style>
        :root { --navy: #001f3f; --success: #2ECC40; --warning: #FF851B; --error: #FF4136; --bg: #f4f7f9; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        header { width: 100%; background: var(--navy); padding: 25px 0; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; }
        .logo { height: 45px; }
        .scanner-card { background: white; width: 90%; max-width: 400px; margin-top: -15px; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; box-sizing: border-box; z-index: 5; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; border: none !important; background: #000; }
        #status-overlay { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 85%; max-width: 340px; padding: 20px; border-radius: 16px; color: white; font-weight: 700; text-align: center; display: none; z-index: 1000; box-shadow: 0 8px 25px rgba(0,0,0,0.3); animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideDown { from { top: -100px; opacity: 0; } to { top: 20px; opacity: 1; } }
        .setup-btn, .sync-btn, .clear-btn { margin-top: 15px; border: none; padding: 14px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; display: block; transition: 0.2s; }
        .setup-btn { background: #eee; color: #555; }
        .sync-btn { background: var(--navy); color: white; display: none; }
        .clear-btn { background: transparent; border: 1px solid var(--error); color: var(--error); margin-top: 8px; display: none; }
        .v-info { margin-top: 15px; font-size: 0.8rem; color: #888; font-weight: 500; }
    </style>
</head>
<body>

<header>
    <img src="https://raw.githubusercontent.com/kuapc-das/kuapc-attendance-pwa/main/logo-login.png" class="logo">
</header>

<div class="scanner-card">
    <div id="reader"></div>
    <div id="v-name" class="v-info">Not Logged In</div>
    
    <button class="sync-btn" id="sync-btn" onclick="processQueue(true)">Sync Queue (0)</button>
    <button class="clear-btn" id="clear-btn" onclick="clearQueue()">Clear Queue</button>
    <button class="setup-btn" onclick="setConfig()">Volunteer Login</button>
</div>

<div id="status-overlay"></div>
<audio id="beep" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
// --- CONFIGURATION ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrCFfksl-gEdJCJnFJ4X74kBiJmWXLvnabdIVFthpQcLiw4btoFNmjSJWUzxxD0_sNAQ/exec"; 
const QUEUE_KEY = 'offlineQueue';

let volunteerToken = localStorage.getItem('vtoken') || "";
const html5QrCode = new Html5Qrcode("reader");
let isProcessing = false;

const syncBtn = document.getElementById('sync-btn');
const clearBtn = document.getElementById('clear-btn');

if(volunteerToken) document.getElementById('v-name').innerText = "Logged in: " + volunteerToken;

// --- CORE FUNCTIONS ---
function setConfig() {
    const token = prompt("Enter Volunteer Token:", volunteerToken);
    if (token) { 
        localStorage.setItem('vtoken', token.trim()); 
        location.reload(); 
    }
}

function updateQueueBadge() {
    const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
    syncBtn.innerText = `Sync Queue (${queue.length})`;
    
    if (queue.length > 0) {
        syncBtn.style.display = "block";
        clearBtn.style.display = "block";
    } else {
        syncBtn.style.display = "none";
        clearBtn.style.display = "none";
    }
}

function clearQueue() {
    const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
    if (confirm(`Delete ${queue.length} unsynced scans? This cannot be undone.`)) {
        localStorage.setItem(QUEUE_KEY, "[]");
        updateQueueBadge();
        showStatus("QUEUE CLEARED", "var(--error)");
        setTimeout(hideStatus, 2000);
    }
}

async function sendScan(id) {
    try {
        const response = await fetch(`${SCRIPT_URL}?pwa=1&id=${encodeURIComponent(id)}&vtoken=${encodeURIComponent(volunteerToken)}`);
        const data = await response.json();
        if(data.status) {
            showStatus(data.message.toUpperCase(), data.status === "success" ? "var(--success)" : (data.status === "warning" ? "var(--warning)" : "var(--error)"));
        }
        return data.status === "success" || data.status === "warning";
    } catch (err) {
        return false;
    }
}

async function processQueue(manual=false) {
    if (!navigator.onLine) {
        if(manual) showStatus("OFFLINE: CANNOT SYNC", "var(--error)");
        setTimeout(hideStatus, 2000);
        return;
    }

    const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
    if (!queue.length) return;
    
    if(manual) showStatus("SYNCING...", "var(--navy)");

    for (let i = 0; i < queue.length; i++) {
        const success = await sendScan(queue[i]);
        if (success) {
            queue.splice(i, 1);
            i--; 
            localStorage.setItem(QUEUE_KEY, JSON.stringify(queue));
            updateQueueBadge();
        } else {
            break;
        }
    }
    
    if(manual && queue.length === 0) {
        showStatus("SYNC COMPLETE", "var(--success)");
        setTimeout(hideStatus, 2000);
    }
}

async function onScanSuccess(decodedText) {
    if (isProcessing || !volunteerToken) return;
    isProcessing = true;
    
    document.getElementById('beep').play();
    if (navigator.vibrate) navigator.vibrate(50);

    showStatus("PROCESSING...", "var(--navy)");

    let sent = false;
    if (navigator.onLine) {
        sent = await sendScan(decodedText);
    }

    if (!sent) {
        const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
        queue.push(decodedText);
        localStorage.setItem(QUEUE_KEY, JSON.stringify(queue));
        
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]); 
        showStatus("SAVED OFFLINE", "var(--warning)");
    }

    updateQueueBadge();
    setTimeout(() => { isProcessing = false; hideStatus(); }, 2500);
}

function showStatus(msg, color) { 
    const div = document.getElementById('status-overlay'); 
    div.innerText = msg; 
    div.style.backgroundColor = color; 
    div.style.display = 'block'; 
}

function hideStatus() { document.getElementById('status-overlay').style.display = 'none'; }

// --- INITIALIZATION ---
if (volunteerToken) {
    html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, onScanSuccess)
        .catch(err => showStatus("CAMERA ERROR", "var(--error)"));
} else {
    showStatus("LOGIN REQUIRED", "var(--navy)");
}

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
    });
}

window.addEventListener('online', () => {
    showStatus("BACK ONLINE: SYNCING...", "var(--success)");
    processQueue();
});

updateQueueBadge();
if (navigator.onLine) processQueue();
</script>
</body>
</html>
